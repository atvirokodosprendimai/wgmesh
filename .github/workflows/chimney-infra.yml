name: Chimney Infrastructure

# Provisions and manages the four-server chimney fleet:
#
#   Origins (blue/green deployment targets):
#     chimney-nbg1  — cax11 arm64, nbg1 (primary EU origin)
#     chimney-fsn1  — cax11 arm64, hel1 (secondary EU origin; fsn1 capacity unavailable)
#
#   Edges (watchtower auto-update):
#     chimney-hel1  — cax11 arm64, hel1 (EU edge)
#     chimney-ash   — cpx11 amd64, ash  (US edge)
#
# All four servers are labeled service=chimney so chimney-deploy.yml
# can discover them automatically.
#
# Actions:
#   provision  — create all servers; origins self-bootstrap via cloud-init (no SSH needed)
#                edge servers: run bootstrap after origins are healthy + WG mesh converged
#   teardown   — delete all chimney servers
#   status     — list servers and check SSH reachability
#   bootstrap  — run setup scripts on existing servers via SSH (after rebuild or for edges)

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action"
        required: true
        type: choice
        options:
          - provision
          - teardown
          - status
          - bootstrap

concurrency:
  group: chimney-infra
  cancel-in-progress: false

env:
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

jobs:
  run:
    name: "Infra: ${{ inputs.action }}"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        if: inputs.action == 'bootstrap'
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
          cache: true

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin hcloud
          hcloud version

      - name: Setup SSH key
        if: inputs.action != 'teardown'
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.CHIMNEY_SSH_KEY }}" > ~/.ssh/chimney
          chmod 600 ~/.ssh/chimney
          ssh-keygen -y -f ~/.ssh/chimney > ~/.ssh/chimney.pub
          echo "SSH_KEY_FILE=$HOME/.ssh/chimney" >> "$GITHUB_ENV"
          echo "Deploy key: $(ssh-keygen -lf ~/.ssh/chimney.pub)"

      # ──────────────── PROVISION ────────────────
      - name: Provision servers
        if: inputs.action == 'provision'
        run: |
          set -euo pipefail

          PUB_KEY=$(cat ~/.ssh/chimney.pub)

          # Upload SSH key to Hetzner (idempotent)
          MD5_FP=$(ssh-keygen -E md5 -lf ~/.ssh/chimney.pub | awk '{print $2}' | sed 's/^MD5://')
          KEY_ID=$(hcloud ssh-key list -o noheader -o columns=id,fingerprint 2>/dev/null \
            | awk -v fp="$MD5_FP" '$2==fp{print $1}' | head -1)
          if [ -z "$KEY_ID" ]; then
            hcloud ssh-key delete "chimney-deploy-key" 2>/dev/null || true
            hcloud ssh-key create --name "chimney-deploy-key" --public-key-from-file ~/.ssh/chimney.pub
          else
            echo "Reusing existing Hetzner SSH key $KEY_ID"
          fi

          # Generate cloud-init for an origin server.
          # All setup files are embedded as base64 blobs; setup-origin.sh runs
          # on first boot via runcmd. No SSH needed from CI runners.
          origin_cloud_init() {
            echo "#cloud-config"
            echo "users:"
            echo "  - name: root"
            echo "    ssh_authorized_keys:"
            echo "      - $PUB_KEY"
            echo ""
            echo "write_files:"
            for f in compose.origin.yml Caddyfile.origin bluegreen.sh setup-origin.sh; do
              echo "  - path: /tmp/$f"
              echo "    encoding: b64"
              printf "    content: %s\n" "$(base64 -w0 deploy/chimney/$f)"
              [[ "$f" == *.sh ]] && echo "    permissions: '0755'"
            done
            ENV_B64=$(printf 'GITHUB_TOKEN=%s\nGITHUB_ACTOR=%s\nWGMESH_SECRET=%s\n' \
              '${{ secrets.PUSH_TOKEN }}' \
              '${{ github.actor }}' \
              '${{ secrets.WGMESH_SECRET }}' | base64 -w0)
            echo "  - path: /tmp/.chimney-env"
            echo "    encoding: b64"
            printf "    content: %s\n" "$ENV_B64"
            echo "    permissions: '0600'"
            echo ""
            echo "runcmd:"
            echo "  - \"bash -c 'set -a; . /tmp/.chimney-env; set +a; bash /tmp/setup-origin.sh > /var/log/chimney-setup.log 2>&1'\""
          }

          # Generate cloud-init for an edge server.
          # Installs Docker and writes config files. The edge stack is started
          # by the bootstrap action once origin WireGuard IPs are known.
          edge_cloud_init() {
            echo "#cloud-config"
            echo "users:"
            echo "  - name: root"
            echo "    ssh_authorized_keys:"
            echo "      - $PUB_KEY"
            echo ""
            echo "write_files:"
            for f in compose.edge.yml Caddyfile.edge setup-edge.sh; do
              echo "  - path: /tmp/$f"
              echo "    encoding: b64"
              printf "    content: %s\n" "$(base64 -w0 deploy/chimney/$f)"
              [[ "$f" == *.sh ]] && echo "    permissions: '0755'"
            done
            ENV_B64=$(printf 'WGMESH_SECRET=%s\n' \
              '${{ secrets.WGMESH_SECRET }}' | base64 -w0)
            echo "  - path: /tmp/.chimney-env"
            echo "    encoding: b64"
            printf "    content: %s\n" "$ENV_B64"
            echo "    permissions: '0600'"
            echo ""
            echo "runcmd:"
            echo "  - curl -fsSL https://get.docker.com | sh"
            echo "  - systemctl enable --now docker"
          }

          # Server definitions: name|location|type|arch|role
          SERVERS=(
            "chimney-nbg1|nbg1|cax11|arm64|origin"
            "chimney-fsn1|hel1|cax11|arm64|origin"
            "chimney-hel1|hel1|cax11|arm64|edge"
            "chimney-ash|ash|cpx11|amd64|edge"
          )

          echo "## Provisioned Servers" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          for spec in "${SERVERS[@]}"; do
            IFS='|' read -r name loc type arch role <<< "$spec"

            if hcloud server describe "$name" >/dev/null 2>&1; then
              IP=$(hcloud server ip "$name")
              echo "$name: already exists ($IP) — skipping"
              echo "- **$name** ($IP): already existed" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi

            echo "Creating $name ($type, $loc, $arch, role=$role)..."
            if [ "$role" = "origin" ]; then
              origin_cloud_init > "/tmp/cloud-init-${name}.yaml"
            else
              edge_cloud_init > "/tmp/cloud-init-${name}.yaml"
            fi

            hcloud server create \
              --name "$name" \
              --type "$type" \
              --image "ubuntu-24.04" \
              --location "$loc" \
              --user-data-from-file "/tmp/cloud-init-${name}.yaml" \
              --label "service=chimney" \
              --label "role=$role" \
              --label "arch=$arch" \
              --label "location=$loc"

            IP=$(hcloud server ip "$name")
            echo "Created $name: $IP"
            echo "- **$name** ($IP): created ✓" >> "$GITHUB_STEP_SUMMARY"
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Origins self-configure on first boot (~3–5 min). Check: \`cat /var/log/chimney-setup.log\`" >> "$GITHUB_STEP_SUMMARY"
          echo "Edges: run **bootstrap** once origins are healthy and WG mesh has converged." >> "$GITHUB_STEP_SUMMARY"

      # ──────────────── BOOTSTRAP ────────────────
      - name: Bootstrap servers
        if: inputs.action == 'bootstrap'
        run: |
          set -euo pipefail

          SHORT_SHA="${GITHUB_SHA::8}"
          LDFLAGS="-s -w -X main.version=chimney-${SHORT_SHA}"

          # Build binaries
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="$LDFLAGS" -o chimney-linux-arm64 ./cmd/chimney/
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="$LDFLAGS" -o chimney-linux-amd64 ./cmd/chimney/

          SCP="scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -i $SSH_KEY_FILE"

          # Discover origin servers
          ORIGINS=$(hcloud server list -l "service=chimney,role=origin" -o noheader -o columns=name,ipv4,type 2>/dev/null)
          # Discover edge servers
          EDGES=$(hcloud server list -l "service=chimney,role=edge" -o noheader -o columns=name,ipv4,type 2>/dev/null)

          echo "## Bootstrap Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # ── Bootstrap origins ──
          while read -r name ip stype; do
            [ -z "$name" ] && continue
            [[ "$stype" == cax* ]] && arch="arm64" || arch="amd64"

            echo "=== Bootstrap origin: $name ($ip, $arch) ==="

            $SCP "chimney-linux-${arch}"              "root@${ip}:/tmp/chimney"
            $SCP deploy/chimney/compose.origin.yml    "root@${ip}:/tmp/compose.origin.yml"
            $SCP deploy/chimney/Caddyfile.origin      "root@${ip}:/tmp/Caddyfile.origin"
            $SCP deploy/chimney/setup-origin.sh       "root@${ip}:/tmp/setup-origin.sh"
            $SCP deploy/chimney/bluegreen.sh          "root@${ip}:/tmp/bluegreen.sh"
            $SCP -r docs                              "root@${ip}:/tmp/docs"

            printf '%s\n%s\n%s\n' \
              '${{ secrets.PUSH_TOKEN }}' \
              '${{ github.actor }}' \
              '${{ secrets.WGMESH_SECRET }}' \
            | ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -o LogLevel=ERROR -i "$SSH_KEY_FILE" "root@${ip}" \
                'read -r GITHUB_TOKEN; read -r GITHUB_ACTOR; read -r WGMESH_SECRET
                 export GITHUB_TOKEN GITHUB_ACTOR WGMESH_SECRET
                 bash /tmp/setup-origin.sh'

            echo "- **$name** ($ip): bootstrapped ✓" >> "$GITHUB_STEP_SUMMARY"
          done <<< "$ORIGINS"

          # ── Get origin WireGuard IPs ──
          ORIGIN_WG_IPS=()
          while read -r name ip stype; do
            [ -z "$name" ] && continue
            WG_IP=$(ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -o LogLevel=ERROR -i "$SSH_KEY_FILE" "root@${ip}" \
              "ip -4 addr show wg0 2>/dev/null | awk '/inet /{print \$2}' | cut -d/ -f1" 2>/dev/null || echo "")
            if [ -n "$WG_IP" ]; then
              ORIGIN_WG_IPS+=("$WG_IP")
              echo "$name WireGuard IP: $WG_IP"
            fi
          done <<< "$ORIGINS"

          ORIGIN_WG_IP_1="${ORIGIN_WG_IPS[0]:-10.0.0.1}"
          ORIGIN_WG_IP_2="${ORIGIN_WG_IPS[1]:-${ORIGIN_WG_IP_1}}"

          # ── Bootstrap edges ──
          while read -r name ip stype; do
            [ -z "$name" ] && continue
            [[ "$stype" == cax* ]] && arch="arm64" || arch="amd64"

            echo "=== Bootstrap edge: $name ($ip, $arch) ==="

            $SCP deploy/chimney/compose.edge.yml  "root@${ip}:/tmp/compose.edge.yml"
            $SCP deploy/chimney/Caddyfile.edge    "root@${ip}:/tmp/Caddyfile.edge"
            $SCP deploy/chimney/setup-edge.sh     "root@${ip}:/tmp/setup-edge.sh"

            printf '%s\n' '${{ secrets.WGMESH_SECRET }}' \
            | ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -o LogLevel=ERROR -i "$SSH_KEY_FILE" "root@${ip}" \
                "read -r WGMESH_SECRET
                 export WGMESH_SECRET
                 ORIGIN_WG_IP_1='${ORIGIN_WG_IP_1}' \
                 ORIGIN_WG_IP_2='${ORIGIN_WG_IP_2}' \
                 bash /tmp/setup-edge.sh"

            echo "- **$name** ($ip): bootstrapped ✓" >> "$GITHUB_STEP_SUMMARY"
          done <<< "$EDGES"

      # ──────────────── STATUS ────────────────
      - name: Status
        if: inputs.action == 'status'
        run: |
          echo "## Chimney Fleet Status" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          hcloud server list -l "service=chimney" \
            -o columns=name,status,ipv4,datacenter,labels >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          hcloud server list -l "service=chimney" \
            -o columns=name,status,ipv4,datacenter

          echo ""
          echo "=== SSH reachability ==="
          while IFS= read -r line; do
            name=$(echo "$line" | awk '{print $1}')
            ip=$(echo "$line" | awk '{print $3}')
            [ -z "$name" ] && continue
            if ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
               -o ConnectTimeout=5 -o LogLevel=ERROR -i "$SSH_KEY_FILE" \
               "root@${ip}" "echo ok" 2>/dev/null | grep -q ok; then
              echo "  $name ($ip): SSH ✓"
            else
              echo "  $name ($ip): SSH FAILED"
            fi
          done < <(hcloud server list -l "service=chimney" -o noheader -o columns=name,status,ipv4 2>/dev/null)

      # ──────────────── TEARDOWN ────────────────
      - name: Teardown
        if: inputs.action == 'teardown'
        run: |
          set -euo pipefail
          SERVERS=$(hcloud server list -l "service=chimney" -o noheader -o columns=name 2>/dev/null) || true

          if [ -z "$SERVERS" ]; then
            echo "No chimney servers found."
            exit 0
          fi

          for name in $SERVERS; do
            echo "Deleting $name..."
            hcloud server delete "$name"
          done

          hcloud ssh-key delete "chimney-deploy-key" 2>/dev/null || true
          echo "All chimney servers removed."

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/chimney ~/.ssh/chimney.pub || true
