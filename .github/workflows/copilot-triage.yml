name: Copilot Issue Triage

# Triggered when an issue is labeled with 'needs-triage'.
# Assigns the issue to GitHub Copilot coding agent with instructions
# to analyze the issue and produce a specification document (no code).

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    if: github.event.label.name == 'needs-triage'
    runs-on: ubuntu-latest
    steps:
      - name: Assign Copilot coding agent to write specification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const issue = context.payload.issue;
            const safeTitle = (issue.title || '')
              .replace(/\r?\n/g, ' ')
              .replace(/`/g, "'")
              .replace(/[<>]/g, '')
              .replace(/\s+/g, ' ')
              .trim()
              .slice(0, 180);

            // Build the spec-writing instructions for the agent_assignment payload.
            // These instructions are passed directly to Copilot coding agent and
            // tell it to produce a specification document, NOT implementation code.
            const specInstructions = [
              `Analyze this issue and create a **specification document only**. Do NOT write implementation code.`,
              ``,
              `Instructions:`,
              `1. Read the issue title and description carefully`,
              `2. Explore the codebase to understand the relevant components`,
              `3. Create a file specs/issue-${issueNumber}-spec.md using this template:`,
              ``,
              `# Specification: Issue #${issueNumber}`,
              ``,
              `## Classification`,
              `<!-- One of: fix, feature, refactor, wont-do, needs-info -->`,
              ``,
              `## Deliverables`,
              `<!-- What needs to be delivered: code, documentation, or both -->`,
              ``,
              `## Problem Analysis`,
              `<!-- Detailed analysis of what is wrong or what is being requested -->`,
              ``,
              `## Proposed Approach`,
              `<!-- Step-by-step approach to solve this -->`,
              `<!-- Be specific about which functions/files to modify -->`,
              ``,
              `## Affected Files`,
              `<!-- List every file that would need changes -->`,
              ``,
              `## Test Strategy`,
              `<!-- How to verify the fix/feature works -->`,
              ``,
              `## Estimated Complexity`,
              `<!-- One of: low, medium, high -->`,
              ``,
              `4. Open a PR titled: spec: Issue #${issueNumber} - ${safeTitle}`,
              `   Include "Issue #${issueNumber}" in the title for pipeline traceability.`,
              `5. Target the main branch`,
              `6. The PR should contain ONLY the spec file - no code changes`,
            ].join('\n');

            // Assign Copilot coding agent using the correct REST API.
            // The assignee must be "copilot-swe-agent[bot]" (not "Copilot").
            // The agent_assignment.custom_instructions field passes our spec prompt.
            // See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-a-pr#using-the-rest-api
            try {
              await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: ['copilot-swe-agent[bot]'],
                agent_assignment: {
                  custom_instructions: specInstructions,
                },
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28',
                },
              });
              console.log(`Assigned copilot-swe-agent[bot] to issue #${issueNumber}`);
            } catch (e) {
              core.setFailed(`Failed to assign Copilot coding agent to issue #${issueNumber}: ${e.message}`);
              return;
            }

            // Post a human-visible comment noting that Copilot has been assigned.
            // The actual instructions were passed via agent_assignment above.
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `Copilot coding agent has been assigned to write a specification for this issue.`,
                ``,
                `**Task:** Create \`specs/issue-${issueNumber}-spec.md\` and open a spec PR.`,
                `No implementation code — spec only.`,
              ].join('\n')
            });

            // Swap labels: remove needs-triage, add copilot-triaging
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'needs-triage'
              });
            } catch (e) {
              console.log('Could not remove needs-triage label:', e.message);
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['copilot-triaging']
            });

            console.log(`Triggered Copilot triage for issue #${issueNumber}`);

            // ── Agent metrics: triage event ──
            const fs = require('fs');
            const metricsPath = `/tmp/agent-metrics-triage-${issueNumber}.json`;
            const issueCreated = new Date(issue.created_at);
            const now = new Date();
            const triageLatency = Math.round((now - issueCreated) / 1000);

            const metrics = {
              schema_version: 1,
              stage: 'triage',
              issue_number: issueNumber,
              timestamp: now.toISOString(),
              issue: {
                created_at: issue.created_at,
                title_length: (issue.title || '').length,
                body_length: (issue.body || '').length,
                time_to_triage_seconds: triageLatency,
              },
              copilot_assigned: true,
            };

            fs.writeFileSync(metricsPath, JSON.stringify(metrics, null, 2));
            core.info(`Agent metrics: triage latency ${triageLatency}s for issue #${issueNumber}`);

      - name: Upload agent metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-metrics-triage-${{ github.event.issue.number }}
          path: /tmp/agent-metrics-triage-*.json
          retention-days: 90
          if-no-files-found: ignore
