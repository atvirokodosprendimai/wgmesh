name: Copilot Spec Revision

# Triggered when a review comment is added to a spec PR.
# Re-assigns to Copilot to address feedback before approval.

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  revision:
    runs-on: ubuntu-latest
    steps:
      - name: Check if this is a spec PR and verify permissions
        id: is-spec
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request || context.payload.issue?.pull_request;
            
            // Only handle spec PRs (created by Copilot for triage)
            if (!pr || !pr.title.toLowerCase().includes('spec:')) {
              console.log('Not a spec PR, skipping revision trigger');
              core.setOutput('should_process', 'false');
              return;
            }
            
            // Verify commenter has write access
            const commenter = context.payload.comment?.user?.login || context.actor;
            try {
              const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commenter
              });
              if (!['admin', 'write'].includes(perm.permission)) {
                console.log(`User @${commenter} lacks write access (has: ${perm.permission}), skipping`);
                core.setOutput('should_process', 'false');
                return;
              }
              console.log(`Verified @${commenter} has ${perm.permission} access`);
            } catch (error) {
              core.warning(`Failed to verify permissions for @${commenter}: ${error.message}`);
              core.setOutput('should_process', 'false');
              return;
            }
            
            // Extract issue number from PR title: "spec: Issue #123 - ..."
            const match = pr.title.match(/Issue #(\d+)/);
            if (!match) {
              console.log('Could not extract issue number from PR title:', pr.title);
              core.setOutput('should_process', 'false');
              return;
            }
            
            const issueNumber = match[1];
            core.setOutput('should_process', 'true');
            core.setOutput('issue_number', issueNumber);
            
            console.log(`Spec PR for issue #${issueNumber} received review comment`);

      - name: Trigger Copilot revision
        if: steps.is-spec.outputs.should_process == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ steps.is-spec.outputs.issue_number }}';
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            const commenter = context.payload.comment?.user?.login || context.actor;
            
            // Add comment noting revision needed
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: [
                  `üìù Review feedback received on spec PR #${prNumber} from @${commenter}.`,
                  ``,
                  "@Copilot Please address the feedback and update the spec accordingly."
                ].join('\n')
              });
            } catch (error) {
              core.warning(`Failed to comment on issue #${issueNumber}: ${error.message}`);
            }
            
            // Re-assign to Copilot to handle the revision
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                assignees: ['Copilot']
              });
            } catch (error) {
              core.warning(`Failed to assign Copilot to issue #${issueNumber}: ${error.message}`);
            }
            
            // Update PR label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['copilot-revising']
              });
            } catch (error) {
              core.warning(`Failed to add label to PR #${prNumber}: ${error.message}`);
            }
            
            console.log(`Triggered Copilot revision for issue #${issueNumber} based on PR #${prNumber} review comment`);
