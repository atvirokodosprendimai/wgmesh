name: Copilot Spec Revision

# Triggered when a review comment is added to a spec PR.
# Re-assigns to Copilot to address feedback before approval.

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  revision:
    # Skip bot-triggered events (Copilot code review comments cause action_required)
    if: >-
      github.actor != 'github-actions[bot]' &&
      github.actor != 'copilot[bot]' &&
      github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check if this is a spec PR and verify permissions
        id: is-spec
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            // Get PR from pull_request_review_comment or issue_comment on PR-linked issue
            let pr = context.payload.pull_request;
            
            // For issue_comment on a PR-linked issue, fetch PR details
            if (!pr && context.payload.issue?.pull_request) {
              const prUrl = context.payload.issue.pull_request.url;
              const prMatch = prUrl.match(/\/pulls\/(\d+)$/);
              if (prMatch) {
                const { data: prData } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: parseInt(prMatch[1])
                });
                pr = prData;
              }
            }
            
            // Only handle spec PRs (created by Copilot for triage)
            if (!pr || !pr.title.toLowerCase().includes('spec:')) {
              console.log('Not a spec PR, skipping revision trigger');
              core.setOutput('should_process', 'false');
              return;
            }
            
            // Verify commenter has write access
            const commenter = context.payload.comment?.user?.login || context.actor;
            try {
              const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commenter
              });
              if (!['admin', 'write'].includes(perm.permission)) {
                console.log(`User @${commenter} lacks write access (has: ${perm.permission}), skipping`);
                core.setOutput('should_process', 'false');
                return;
              }
              console.log(`Verified @${commenter} has ${perm.permission} access`);
            } catch (error) {
              core.warning(`Failed to verify permissions for @${commenter}: ${error.message}`);
              core.setOutput('should_process', 'false');
              return;
            }
            
            // Extract issue number from PR title: "spec: Issue #123 - ..."
            const match = pr.title.match(/Issue #(\d+)/);
            if (!match) {
              console.log('Could not extract issue number from PR title:', pr.title);
              core.setOutput('should_process', 'false');
              return;
            }
            
            const issueNumber = match[1];
            core.setOutput('should_process', 'true');
            core.setOutput('issue_number', issueNumber);
            core.setOutput('pr_number', pr.number);
            
            console.log(`Spec PR #${pr.number} for issue #${issueNumber} received review comment`);

      - name: Trigger Copilot revision
        if: steps.is-spec.outputs.should_process == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const issueNumber = '${{ steps.is-spec.outputs.issue_number }}';
            const prNumber = '${{ steps.is-spec.outputs.pr_number }}';
            const commenter = context.payload.comment?.user?.login || context.actor;
            
            // Add comment noting revision needed
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: [
                  `Review feedback received on spec PR #${prNumber} from @${commenter}.`,
                  ``,
                  `Copilot coding agent has been re-assigned to address the feedback.`,
                ].join('\n')
              });
            } catch (error) {
              core.warning(`Failed to comment on issue #${issueNumber}: ${error.message}`);
            }

            // Re-assign Copilot coding agent using the correct REST API.
            // Must use "copilot-swe-agent[bot]" as the assignee name.
            try {
              await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                assignees: ['copilot-swe-agent[bot]'],
                agent_assignment: {
                  custom_instructions: `Review feedback was left on spec PR #${prNumber}. Please address the feedback and update the spec file accordingly. Do NOT write implementation code.`,
                },
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28',
                },
              });
              console.log(`Re-assigned copilot-swe-agent[bot] to issue #${issueNumber}`);
            } catch (error) {
              core.warning(`Failed to assign Copilot coding agent to issue #${issueNumber}: ${error.message}`);
            }
            
            // Update PR label
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['copilot-revising']
              });
            } catch (error) {
              core.warning(`Failed to add label to PR #${prNumber}: ${error.message}`);
            }
            
            console.log(`Triggered Copilot revision for issue #${issueNumber} based on PR #${prNumber} review comment`);
