name: PR Review Handler

# Uses native GitHub PR review flow:
#   Approve        → labels PR 'approved-for-build', triggers Goose implementation
#   Request Changes → re-assigns Copilot to address feedback
#   Close PR       → rejection (no workflow needed, just close it)
#
# For non-spec PRs (impl/fix/feat):
#   Issue creator approval → labels PR 'issue-creator-approved', enables auto-merge

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ──────────────────────────────────────────────────────
  # Spec PR Approved → Trigger Goose build
  # ──────────────────────────────────────────────────────
  approve-spec:
    if: >-
      github.event.review.state == 'approved' &&
      contains(github.event.pull_request.title, 'spec:')
    runs-on: ubuntu-latest
    steps:
      - name: Label PR and notify original issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const reviewer = context.payload.review.user.login;

            // Extract issue number from PR title: "spec: Issue #123 - ..."
            const issueMatch = pr.title.match(/Issue #(\d+)/);
            const issueNumber = issueMatch ? parseInt(issueMatch[1], 10) : null;

            // Add the approved-for-build label for tracking
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['approved-for-build']
            });

            // Update the original issue
            if (issueNumber) {
              // Remove copilot-triaging label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'copilot-triaging'
                });
              } catch (e) {
                if (e.status !== 404) {
                  core.warning(`Failed to remove copilot-triaging label: ${e.message}`);
                }
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  `**Build approved** by @${reviewer}`,
                  ``,
                  `Goose will now implement the code based on the specification in PR #${prNumber}.`,
                ].join('\n')
              });
            }

            // Directly trigger Goose implementation via workflow_dispatch.
            // Labels added by workflows don't fire pull_request events (GitHub limitation),
            // so we invoke goose-build.yml explicitly.
            if (issueNumber) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'goose-build.yml',
                ref: 'main',
                inputs: {
                  issue_number: String(issueNumber),
                  spec_pr_number: String(prNumber),
                },
              });
              console.log(`Triggered Goose implementation for issue #${issueNumber}`);
            }

            console.log(`Spec PR #${prNumber} approved by @${reviewer}, Goose triggered`);

  # ──────────────────────────────────────────────────────
  # Non-spec PR: Issue creator approval → auto-merge
  # ──────────────────────────────────────────────────────
  approve-by-issue-creator:
    if: >-
      github.event.review.state == 'approved' &&
      !contains(github.event.pull_request.title, 'spec:')
    runs-on: ubuntu-latest
    steps:
      - name: Check if reviewer is the issue creator and auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const reviewer = context.payload.review.user.login;

            // Extract issue number from PR body ("Fixes #N") or title ("Issue #N")
            const bodyMatch = pr.body?.match(/[Ff]ixes\s+(?:[\w-]+\/[\w-]+)?#(\d+)/);
            const titleMatch = pr.title.match(/(?:Issue |#)(\d+)/i);
            const issueNumber = bodyMatch
              ? parseInt(bodyMatch[1], 10)
              : titleMatch
                ? parseInt(titleMatch[1], 10)
                : null;

            if (!issueNumber) {
              console.log('No linked issue found in PR title or body, skipping issue-creator check');
              return;
            }

            // Fetch the original issue to get creator
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const issueCreator = issue.user.login;
            console.log(`PR #${prNumber} fixes issue #${issueNumber} (created by @${issueCreator})`);
            console.log(`Reviewer: @${reviewer}`);

            if (reviewer !== issueCreator) {
              console.log(`Reviewer @${reviewer} is not the issue creator @${issueCreator}, skipping`);
              return;
            }

            console.log(`Issue creator @${issueCreator} approved PR #${prNumber}`);

            // Label the PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['issue-creator-approved']
            });

            // Squash-merge directly — enablePullRequestAutoMerge is rejected
            // when the PR is already in 'clean' (immediately mergeable) state.
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
              });
              console.log(`PR #${prNumber} squash-merged`);
            } catch (error) {
              core.warning(`Could not merge PR: ${error.message}`);
            }

            // Comment on the issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `**Approved by issue creator** @${issueCreator}`,
                ``,
                `PR #${prNumber} has been approved and auto-merge is enabled.`,
                `It will merge once all required checks pass.`,
              ].join('\n')
            });

            console.log(`Issue creator approval processed for PR #${prNumber}`);

  # ──────────────────────────────────────────────────────
  # Spec PR: Changes Requested → Re-assign Copilot to revise
  # ──────────────────────────────────────────────────────
  revision:
    if: >-
      github.event.review.state == 'changes_requested' &&
      contains(github.event.pull_request.title, 'spec:')
    runs-on: ubuntu-latest
    steps:
      - name: Re-assign Copilot to address feedback
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const reviewer = context.payload.review.user.login;
            const reviewBody = context.payload.review.body || '(no comment)';

            // Extract issue number from PR title
            const issueMatch = pr.title.match(/Issue #(\d+)/);
            const issueNumber = issueMatch ? parseInt(issueMatch[1], 10) : null;

            if (!issueNumber) {
              core.warning('Could not extract issue number from PR title: ' + pr.title);
              return;
            }

            // Re-assign Copilot coding agent with revision instructions
            try {
              await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: ['copilot-swe-agent[bot]'],
                agent_assignment: {
                  custom_instructions: [
                    `Changes were requested on spec PR #${prNumber} by @${reviewer}.`,
                    ``,
                    `Review feedback:`,
                    reviewBody,
                    ``,
                    `Please address the feedback and update the spec file. Do NOT write implementation code.`,
                  ].join('\n'),
                },
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28',
                },
              });
              console.log(`Re-assigned copilot-swe-agent[bot] to issue #${issueNumber}`);
            } catch (error) {
              core.setFailed(`Failed to assign Copilot: ${error.message}`);
              return;
            }

            // Comment on original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                `Changes requested on spec PR #${prNumber} by @${reviewer}.`,
                ``,
                `Copilot coding agent has been re-assigned to address the feedback.`,
              ].join('\n')
            });

            // Label the PR
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['copilot-revising']
              });
            } catch (error) {
              core.warning(`Failed to add label: ${error.message}`);
            }

            console.log(`Triggered Copilot revision for issue #${issueNumber}`);
