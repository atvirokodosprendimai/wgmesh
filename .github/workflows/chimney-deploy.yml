name: Chimney Deploy

# Triggered after chimney-build.yml pushes a new image to ghcr.io.
# Performs blue/green deploy on origin servers and verifies edge health.
#
# Flow:
#   1. Discover chimney-* servers via Hetzner labels
#   2. Blue/green deploy on each origin (nbg1, fsn1) sequentially
#      — new image pulled, inactive slot started, health check, Caddy switched,
#        old slot drained and stopped
#   3. Edge servers self-update via watchtower (30s poll) — no SSH needed
#   4. Smoke tests against chimney.beerpub.dev

on:
  workflow_run:
    workflows: ["Chimney Build and Push"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      image:
        description: "Image to deploy (e.g. sha-abc1234). Empty = latest."
        required: false
        default: ""

concurrency:
  group: chimney-deploy
  cancel-in-progress: false

env:
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
  IMAGE_BASE: ghcr.io/atvirokodosprendimai/wgmesh/chimney

jobs:
  deploy:
    name: Blue/green deploy to origins
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Skip if triggered by a failed build
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin hcloud

      - name: Resolve image tag
        id: image
        run: |
          if [ -n "${{ inputs.image }}" ]; then
            TAG="${{ env.IMAGE_BASE }}:${{ inputs.image }}"
          else
            # Use the SHA tag from the triggering build, or fall back to latest
            SHA="${{ github.event.workflow_run.head_sha }}"
            if [ -n "$SHA" ]; then
              SHORT="${SHA::8}"
              TAG="${{ env.IMAGE_BASE }}:sha-${SHORT}"
            else
              TAG="${{ env.IMAGE_BASE }}:latest"
            fi
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Deploying image: ${TAG}"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.CHIMNEY_SSH_KEY }}" > ~/.ssh/chimney
          chmod 600 ~/.ssh/chimney
          echo "SSH_KEY_FILE=$HOME/.ssh/chimney" >> "$GITHUB_ENV"

      - name: Discover origin servers
        id: origins
        run: |
          set -euo pipefail
          SERVERS=$(hcloud server list -l "service=chimney,role=origin" \
            -o noheader -o columns=name,ipv4,type 2>/dev/null) || true

          if [ -z "$SERVERS" ]; then
            echo "No origin servers found — skipping deploy"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "$SERVERS"

          # Emit as file for next steps
          echo "$SERVERS" > /tmp/origins.txt

      - name: Blue/green deploy to origins
        if: steps.origins.outputs.found == 'true'
        run: |
          set -euo pipefail
          IMAGE="${{ steps.image.outputs.tag }}"

          echo "## Deploy: $IMAGE" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          while IFS= read -r line; do
            name=$(echo "$line" | awk '{print $1}')
            ip=$(echo "$line" | awk '{print $2}')
            [ -z "$name" ] && continue

            echo "=== Deploy to $name ($ip) ==="

            # Copy deploy files (keeps compose + caddy config current)
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -o LogLevel=ERROR -i "$SSH_KEY_FILE" \
                deploy/chimney/bluegreen.sh \
                deploy/chimney/compose.origin.yml \
                deploy/chimney/Caddyfile.origin \
                "root@${ip}:/opt/chimney/"

            # Run blue/green deploy — passes image as env var
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                -o LogLevel=ERROR -i "$SSH_KEY_FILE" "root@${ip}" \
                "IMAGE='${IMAGE}' bash /opt/chimney/bluegreen.sh"

            echo "- **$name** ($ip): deployed ✓" >> "$GITHUB_STEP_SUMMARY"
          done < /tmp/origins.txt

      - name: Wait for edge self-update (watchtower)
        run: |
          echo "Edge nodes update automatically via watchtower (30s poll)."
          echo "Waiting 60s for edges to converge on new image..."
          sleep 60

      - name: Smoke tests
        if: steps.origins.outputs.found == 'true'
        run: |
          set -euo pipefail
          echo "## Smoke Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          PASS=0; FAIL=0

          check() {
            local desc="$1" url="$2" expect="$3"
            local attempt=1 body=""
            while [ $attempt -le 3 ]; do
              body=$(curl -sf --max-time 15 "$url" 2>/dev/null) || body=""
              case "$body" in
                *"$expect"*)
                  echo "  PASS: $desc"
                  echo "- :white_check_mark: $desc" >> "$GITHUB_STEP_SUMMARY"
                  PASS=$((PASS+1))
                  return ;;
              esac
              attempt=$((attempt+1))
              [ $attempt -le 3 ] && sleep 10
            done
            echo "  FAIL: $desc (expected '$expect', got: ${body:0:80})"
            echo "- :x: $desc" >> "$GITHUB_STEP_SUMMARY"
            FAIL=$((FAIL+1))
          }

          check "healthz ok"            "https://chimney.beerpub.dev/healthz"  '"status":"ok"'
          check "dashboard loads"       "https://chimney.beerpub.dev/"         "Agent Pipeline Dashboard"
          check "github api proxy"      "https://chimney.beerpub.dev/api/github/pulls?per_page=1&state=all" '"number"'
          check "cache stats"           "https://chimney.beerpub.dev/api/cache/stats" '"mem_entries"'

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**$PASS passed, $FAIL failed**" >> "$GITHUB_STEP_SUMMARY"

          [ "$FAIL" -eq 0 ] || { echo "::error::$FAIL smoke test(s) failed"; exit 1; }

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/chimney || true
