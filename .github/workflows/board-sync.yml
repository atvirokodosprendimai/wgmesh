name: Sync Board Status

# Keeps the project board in sync with reality.
# Labels are facts applied by other workflows — this one just
# moves items to the matching column so the board is always accurate.

on:
  issues:
    types: [opened, labeled, closed, reopened]
  pull_request_target:
    types: [opened, labeled, closed, reopened]

env:
  PROJECT_ID: "PVT_kwDODz4fRs4BPUe4"
  STATUS_FIELD_ID: "PVTSSF_lADODz4fRs4BPUe4zg9wy0k"
  # Status option IDs (from project field config)
  COL_TRIAGE: "143459d8"
  COL_SPEC_IN_PROGRESS: "df36dcdd"
  COL_REVIEW_SPEC: "e02be665"
  COL_BUILDING: "90ac9853"
  COL_REVIEW_CODE: "6f5cea95"
  COL_DONE: "2db825da"

permissions:
  issues: read
  pull-requests: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Move item to correct column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const projectId = process.env.PROJECT_ID;
            const fieldId = process.env.STATUS_FIELD_ID;

            // Label → column mapping (first match wins, order = priority)
            const labelToColumn = [
              { labels: ['needs-review'],                       col: process.env.COL_REVIEW_CODE },
              { labels: ['approved-for-build', 'goose-implementation'], col: process.env.COL_BUILDING },
              { labels: ['spec-ready'],                         col: process.env.COL_REVIEW_SPEC },
              { labels: ['copilot-triaging', 'copilot-revising'], col: process.env.COL_SPEC_IN_PROGRESS },
              { labels: ['needs-triage'],                       col: process.env.COL_TRIAGE },
            ];

            // Get the content node ID (issue or PR)
            const item = context.payload.issue || context.payload.pull_request;
            const nodeId = item.node_id;
            const itemLabels = item.labels.map(l => l.name);
            const isClosed = item.state === 'closed';

            // Determine target column
            let targetCol = null;

            if (isClosed) {
              targetCol = process.env.COL_DONE;
            } else {
              for (const rule of labelToColumn) {
                if (rule.labels.some(l => itemLabels.includes(l))) {
                  targetCol = rule.col;
                  break;
                }
              }
            }

            // Newly opened/reopened items with no matching label:
            //   issues → Triage, PRs → Review Code
            if (!targetCol && (context.payload.action === 'opened' || context.payload.action === 'reopened')) {
              const isPR = !!context.payload.pull_request;
              targetCol = isPR ? process.env.COL_REVIEW_CODE : process.env.COL_TRIAGE;
            }

            if (!targetCol) {
              console.log(`No column mapping for labels: [${itemLabels.join(', ')}]`);
              return;
            }

            // Find or add the item on the project board
            const { node } = await github.graphql(`
              query($nodeId: ID!) {
                node(id: $nodeId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                  ... on PullRequest {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                }
              }
            `, { nodeId });

            let projectItemId = null;
            const items = node?.projectItems?.nodes || [];
            const match = items.find(i => i.project.id === projectId);

            if (match) {
              projectItemId = match.id;
            } else {
              // Item not on the board yet — add it
              const addResult = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                    item { id }
                  }
                }
              `, { projectId, contentId: nodeId });
              projectItemId = addResult.addProjectV2ItemById.item.id;
              console.log(`Added to board: ${item.title}`);
            }

            // Update the status field
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: {singleSelectOptionId: $optionId}
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId,
              itemId: projectItemId,
              fieldId,
              optionId: targetCol,
            });

            const colNames = {
              [process.env.COL_TRIAGE]: 'Triage',
              [process.env.COL_SPEC_IN_PROGRESS]: 'Spec in Progress',
              [process.env.COL_REVIEW_SPEC]: 'Review Spec',
              [process.env.COL_BUILDING]: 'Building',
              [process.env.COL_REVIEW_CODE]: 'Review Code',
              [process.env.COL_DONE]: 'Done',
            };
            console.log(`Moved "${item.title}" → ${colNames[targetCol]}`);
