name: Sync Board Status

# Keeps the project board in sync with reality.
# Labels are facts applied by other workflows — this one just
# moves items to the matching column so the board is always accurate.

on:
  issues:
    types: [labeled, closed, reopened]
  pull_request:
    types: [labeled, closed, reopened]

env:
  PROJECT_ID: "PVT_kwDODz4fRs4BPUe4"
  STATUS_FIELD_ID: "PVTSSF_lADODz4fRs4BPUe4zg9wy0k"
  # Status option IDs (from project field config)
  COL_TRIAGE: "ed07969f"
  COL_SPEC_WRITING: "d75e0f81"
  COL_SPEC_REVIEW: "2db1217e"
  COL_IMPLEMENTATION: "2c2ac261"
  COL_CODE_REVIEW: "f78e6df2"
  COL_DONE: "9fec38aa"

permissions:
  issues: read
  pull-requests: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Move item to correct column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PUSH_TOKEN }}
          script: |
            const projectId = process.env.PROJECT_ID;
            const fieldId = process.env.STATUS_FIELD_ID;

            // Label → column mapping (first match wins, order = priority)
            const labelToColumn = [
              { labels: ['needs-review'],                       col: process.env.COL_CODE_REVIEW },
              { labels: ['approved-for-build', 'goose-implementation'], col: process.env.COL_IMPLEMENTATION },
              { labels: ['spec-ready'],                         col: process.env.COL_SPEC_REVIEW },
              { labels: ['copilot-triaging', 'copilot-revising'], col: process.env.COL_SPEC_WRITING },
              { labels: ['needs-triage'],                       col: process.env.COL_TRIAGE },
            ];

            // Get the content node ID (issue or PR)
            const item = context.payload.issue || context.payload.pull_request;
            const nodeId = item.node_id;
            const itemLabels = item.labels.map(l => l.name);
            const isClosed = item.state === 'closed';

            // Determine target column
            let targetCol = null;

            if (isClosed) {
              targetCol = process.env.COL_DONE;
            } else {
              for (const rule of labelToColumn) {
                if (rule.labels.some(l => itemLabels.includes(l))) {
                  targetCol = rule.col;
                  break;
                }
              }
            }

            // Reopened items with no matching label go back to Triage
            if (!targetCol && context.payload.action === 'reopened') {
              targetCol = process.env.COL_TRIAGE;
            }

            if (!targetCol) {
              console.log(`No column mapping for labels: [${itemLabels.join(', ')}]`);
              return;
            }

            // Find or add the item on the project board
            const { node } = await github.graphql(`
              query($nodeId: ID!, $projectId: ID!) {
                node(id: $nodeId) {
                  ... on Issue {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                  ... on PullRequest {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                }
              }
            `, { nodeId, projectId });

            let projectItemId = null;
            const items = node?.projectItems?.nodes || [];
            const match = items.find(i => i.project.id === projectId);

            if (match) {
              projectItemId = match.id;
            } else {
              // Item not on the board yet — add it
              const addResult = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                    item { id }
                  }
                }
              `, { projectId, contentId: nodeId });
              projectItemId = addResult.addProjectV2ItemById.item.id;
              console.log(`Added to board: ${item.title}`);
            }

            // Update the status field
            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: {singleSelectOptionId: $optionId}
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId,
              itemId: projectItemId,
              fieldId,
              optionId: targetCol,
            });

            const colNames = {
              [process.env.COL_TRIAGE]: 'Triage',
              [process.env.COL_SPEC_WRITING]: 'Spec Writing',
              [process.env.COL_SPEC_REVIEW]: 'Spec Review',
              [process.env.COL_IMPLEMENTATION]: 'Implementation',
              [process.env.COL_CODE_REVIEW]: 'Code Review',
              [process.env.COL_DONE]: 'Done',
            };
            console.log(`Moved "${item.title}" → ${colNames[targetCol]}`);
