name: Hetzner Integration Tests

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tiers:
        description: 'Test tiers to run (comma-separated: 1,2,3,4,5,6,7)'
        required: false
        default: '1,2,3,4,5,6,7'
      vm_count:
        description: 'Number of VMs per tier (1 introducer + N-1 nodes)'
        required: false
        default: '5'

# Only one integration test run at a time (shared Hetzner infra)
concurrency:
  group: hetzner-integration
  cancel-in-progress: true

env:
  HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
  GO_VERSION: '1.23'

jobs:
  # -----------------------------------------------------------------------
  # Phase 1: Build the binary once, share via artifact
  # -----------------------------------------------------------------------
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tiers: ${{ steps.parse.outputs.tiers }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary (linux/arm64)
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -v \
            -ldflags="-s -w -X main.version=ci-${GITHUB_SHA::8}" \
            -o wgmesh-linux-arm64 .
          ls -lh wgmesh-linux-arm64

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: wgmesh-binary
          path: wgmesh-linux-arm64
          retention-days: 1

      - name: Parse tiers into matrix
        id: parse
        run: |
          TIERS="${{ inputs.tiers || '1,2,3,4,5,6,7' }}"
          # Convert "1,2,3" → ["1","2","3"] JSON array
          JSON=$(echo "$TIERS" | tr ',' '\n' | jq -R . | jq -s -c .)
          echo "tiers=$JSON" >> "$GITHUB_OUTPUT"
          echo "Tier matrix: $JSON"

  # -----------------------------------------------------------------------
  # Phase 2: Run each tier in parallel, each with its own VMs
  #
  # Each tier gets a unique VM_PREFIX (wgmesh-t<N>) so they don't collide.
  #
  # Observed durations (5 VMs, from run 22157008686):
  #   Tier 1 (Topology):         ~5 min
  #   Tier 2 (Peer Lifecycle):  ~12 min
  #   Tier 3 (Network Chaos):   ~55 min  (9 tests × ~6 min each)
  #   Tier 4 (Partitions):      ~15 min
  #   Tier 5 (NAT Simulation):   ~1 min  (all SKIP — not yet implemented)
  #   Tier 6 (Chaos Monkey):    ~35 min
  #   Tier 7 (Stability Soak):  ~35 min  (5+10+15 min soaks)
  #
  # 90 min gives generous buffer for the heaviest tiers (3, 6, 7)
  # plus ~3 min provisioning overhead per tier.
  # -----------------------------------------------------------------------
  tier:
    name: "Tier ${{ matrix.tier }}"
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        tier: ${{ fromJson(needs.build.outputs.tiers) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: wgmesh-binary

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin hcloud
          hcloud version

      - name: Generate ephemeral SSH key
        run: |
          ssh-keygen -t ed25519 -f ~/.ssh/wgmesh-ci -N "" -q
          echo "SSH_KEY_FILE=$HOME/.ssh/wgmesh-ci" >> "$GITHUB_ENV"

      - name: Clean up orphaned VMs
        run: |
          source testlab/cloud/lib.sh
          source testlab/cloud/provision.sh
          teardown_orphans || true
        env:
          SSH_KEY_FILE: ${{ env.SSH_KEY_FILE }}
          VM_PREFIX: "wgmesh-t${{ matrix.tier }}"

      - name: "Run Tier ${{ matrix.tier }} tests"
        id: tests
        run: |
          chmod +x testlab/cloud/*.sh wgmesh-linux-arm64
          ./testlab/cloud/test-cloud.sh \
            --binary "$PWD/wgmesh-linux-arm64" \
            --vms "${{ inputs.vm_count || '5' }}" \
            --tiers "${{ matrix.tier }}"
        env:
          SSH_KEY_FILE: ${{ env.SSH_KEY_FILE }}
          WGMESH_RUN_ID: "${{ github.run_id }}-t${{ matrix.tier }}"
          VM_PREFIX: "wgmesh-t${{ matrix.tier }}"

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "tier-${{ matrix.tier }}-logs"
          path: /tmp/wgmesh-ci-logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Teardown VMs (safety net)
        if: always()
        run: |
          source testlab/cloud/lib.sh
          source testlab/cloud/provision.sh
          teardown_vms || true
          teardown_orphans || true
        env:
          SSH_KEY_FILE: ${{ env.SSH_KEY_FILE }}
          WGMESH_RUN_ID: "${{ github.run_id }}-t${{ matrix.tier }}"
          VM_PREFIX: "wgmesh-t${{ matrix.tier }}"

  # -----------------------------------------------------------------------
  # Phase 3: Aggregate results from all tiers
  # -----------------------------------------------------------------------
  results:
    name: Test Results
    runs-on: ubuntu-latest
    needs: tier
    if: always()
    timeout-minutes: 5
    steps:
      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          pattern: "tier-*-logs"
          merge-multiple: true
          path: logs

      - name: Summary
        run: |
          echo "## Integration Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -d logs ] && ls logs/*.log >/dev/null 2>&1; then
            for log in logs/*.log; do
              node=$(basename "$log" .log)
              errors=$(grep -ciE 'panic|fatal|data race' "$log" 2>/dev/null || echo 0)
              if [ "$errors" -gt 0 ]; then
                echo "- **$node**: $errors error pattern(s)" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "- $node: clean" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          else
            echo "No log files collected." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "See individual **Tier N** jobs for PASS/FAIL/SKIP details." >> "$GITHUB_STEP_SUMMARY"

  # -----------------------------------------------------------------------
  # Periodic orphan cleanup — runs on workflow_dispatch only
  # -----------------------------------------------------------------------
  cleanup-orphans:
    name: Cleanup Orphaned VMs
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin hcloud

      - name: Cleanup orphans
        run: |
          for prefix in wgmesh-t1 wgmesh-t2 wgmesh-t3 wgmesh-t4 wgmesh-t5 wgmesh-t6 wgmesh-t7 wgmesh-ci; do
            export SSH_KEY_FILE=/dev/null
            export VM_PREFIX="$prefix"
            source testlab/cloud/lib.sh
            source testlab/cloud/provision.sh
            teardown_orphans || true
          done
